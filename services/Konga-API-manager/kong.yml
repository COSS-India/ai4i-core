_format_version: "3.0"

_transform: true


# ============================================
# AIV4-Core Kong API Gateway Configuration
# ============================================
# This file defines all services, routes, upstreams, and plugins
# for the AIV4-Core microservices architecture.


# ============================================
# UPSTREAMS - Service pools with load balancing
# ============================================
# All routes now go through the FastAPI API Gateway Service
# This centralizes JWT/OAuth/RBAC logic in the gateway
upstreams:
  - name: api-gateway-upstream
    algorithm: round-robin
    healthchecks:
      active:
        http_path: /health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
        timeout: 5


# ============================================
# TARGETS - Backend service instances
# ============================================
# Single target pointing to the API Gateway
targets:
  - target: ai4v-api-gateway:8080
    upstream: api-gateway-upstream
    weight: 100


# ============================================
# SERVICES - API service definitions
# ============================================


# Authentication Service (Public - No Auth Required)
# Routes through API Gateway which handles JWT/OAuth/RBAC
services:
  - name: auth-service
    url: http://api-gateway-upstream
    routes:
      # Specific route for /api/v1/auth/login - must come BEFORE general /api/v1/auth route
      # This ensures OPTIONS preflight requests are matched correctly
      - name: auth-login-route
        paths:
          - /api/v1/auth/login
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
        methods:
          - GET
          - POST
          - PUT
          - DELETE
          - PATCH
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: ip
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Forwarded-For:$(proxy_proxy_address)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Auth-Service"
      # General auth route for all other /api/v1/auth/* paths
      - name: auth-route
        paths:
          - /api/v1/auth
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - PATCH
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: ip
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Forwarded-For:$(proxy_proxy_address)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Auth-Service"


  # Configuration Service
  - name: config-service
    url: http://api-gateway-upstream
    routes:
      - name: config-route
        paths:
          - /api/v1/config
        strip_path: false
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - PATCH
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
  
  # Feature Flags Service (Unleash)
  - name: feature-flags-service
    url: http://api-gateway-upstream
    routes:
      - name: feature-flags-route
        paths:
          - /api/v1/feature-flags
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: ip
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Feature-Flags-Service"


  # Metrics Service
  - name: metrics-service
    url: http://api-gateway-upstream
    routes:
      - name: metrics-route
        paths:
          - /api/v1/metrics
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 300
              hour: 3000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false


  # Telemetry Service
  - name: telemetry-service
    url: http://api-gateway-upstream
    routes:
      - name: telemetry-route
        paths:
          - /api/v1/telemetry
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 500
              hour: 5000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false


  # Alerting Service
  - name: alerting-service
    url: http://api-gateway-upstream
    routes:
      - name: alerting-route
        paths:
          - /api/v1/alerting
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false

  # Alerts Management Service (Alert Definitions, Receivers, Routing Rules)
  - name: alerts-service
    url: http://api-gateway-upstream
    routes:
      - name: alerts-route
        paths:
          - /api/v1/alerts
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - DELETE
                - PATCH
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: rate-limiting
            config:
              minute: 200
              hour: 2000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Alerts-Service"


  # Dashboard Service
  - name: dashboard-service
    url: http://api-gateway-upstream
    routes:
      - name: dashboard-route
        paths:
          - /api/v1/dashboard
        strip_path: false
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false


  # ASR Service (AI Service - Language-Aware Routing)
  - name: asr-service
    url: http://api-gateway-upstream
    routes:
      - name: asr-route
        paths:
          - /api/v1/asr
        strip_path: true
        methods:
          - GET
          - POST
          - PUT
        plugins:
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
                  - "X-Language-Detection-Source:Kong"
                  - "X-Forwarded-For:$(proxy_proxy_address)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:ASR-Service"
                  - "X-Response-Time:$(latency)"


  # TTS Service (AI Service)
  - name: tts-service
    url: http://api-gateway-upstream
    routes:
      - name: tts-route
        paths:
          - /api/v1/tts
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 100
              hour: 1000
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:TTS-Service"


  # NMT Service (AI Service - Language-Aware Routing)
  - name: nmt-service
    url: http://api-gateway-upstream
    routes:
      - name: nmt-route
        paths:
          - /api/v1/nmt
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
        methods:
          - GET
          - POST
          - PUT
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 150
              hour: 1500
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:NMT-Service"


  # Pipeline Service (AI Orchestration)
  - name: pipeline-service
    url: http://api-gateway-upstream
    routes:
      - name: pipeline-route
        paths:
          - /api/v1/pipeline
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
        methods:
          - GET
          - POST
          - PUT
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 50
              hour: 500
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Pipeline-Service"


  # Model Management Service
  - name: model-management-service
    url: http://api-gateway-upstream
    routes:
      - name: model-management-route
        paths:
          - /api/v1/model-management
        strip_path: false
        # No methods filter = matches all HTTP methods including OPTIONS
        plugins:
          # CORS must be FIRST to handle OPTIONS preflight before authentication
          - name: cors
            config:
              origins:
                - "http://localhost:3000"
              methods:
                - GET
                - POST
                - PUT
                - OPTIONS
              credentials: true
              max_age: 3600
          - name: key-auth
            config:
              key_names:
                - apikey
                - X-API-Key
              hide_credentials: true
          - name: rate-limiting
            config:
              minute: 50
              hour: 500
              limit_by: consumer
              policy: redis
              redis_host: redis
              redis_port: 6379
              redis_password: ${REDIS_PASSWORD}
              redis_database: 1
              redis_timeout: 2000
              redis_ssl: false
              redis_ssl_verify: false
          - name: request-transformer
            config:
              add:
                headers:
                  - "X-Correlation-ID:$(uuid)"
                  - "X-Request-ID:$(uuid)"
                  - "X-Gateway-Timestamp:$(now)"
          - name: response-transformer
            config:
              add:
                headers:
                  - "X-Served-By:Kong-Gateway"
                  - "X-Service:Model-Management-Service"

# ============================================
# CONSUMERS - API key users
# ============================================
consumers:
  - username: ai4voice-client
    tags:
      - production
      - ai-services
    keyauth_credentials:
      - key: ai4voice-secure-key-2024-change-in-production
        tags:
          - ai-services
          - full-access


  - username: asr-client
    tags:
      - production
    keyauth_credentials:
      - key: asr-secure-key-2024-change-in-production
        tags:
          - asr-only


  - username: tts-client
    tags:
      - production
    keyauth_credentials:
      - key: tts-secure-key-2024-change-in-production
        tags:
          - tts-only


  - username: nmt-client
    tags:
      - production
    keyauth_credentials:
      - key: nmt-secure-key-2024-change-in-production
        tags:
          - nmt-only


  - username: pipeline-client
    tags:
      - production
    keyauth_credentials:
      - key: pipeline-secure-key-2024-change-in-production
        tags:
          - pipeline-only


  - username: model-management-client
    tags:
      - production
    keyauth_credentials:
      - key: model-management-secure-key-2024-change-in-production
        tags:
          - model-management-only


  - username: developer-client
    tags:
      - development
    keyauth_credentials:
      - key: developer-secure-key-2024-change-in-production
        tags:
          - development


# ============================================
# GLOBAL PLUGINS - Applied to all requests
# ============================================
plugins:
  # Prometheus metrics plugin
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true


  # Correlation ID plugin (for request tracing)
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      echo_downstream: true


  # Request ID plugin (commented out - not enabled in Kong 3.4 by default)
  # - name: request-id
  #   config:
  #     header_name: X-Request-ID
  #     echo_downstream: true


# ============================================
# END OF CONFIGURATION
# ============================================
# Note: Custom plugins like 'language-router' need to be
# implemented separately and mounted into Kong container.
# See IMPLEMENTATION_PROMPT.md for details.


