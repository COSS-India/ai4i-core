[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On

[FILTER]
    Name                grep
    Match               docker.*
    Regex               log ^\{
    # Only keep logs that start with { (JSON logs)
    # This filters out plain text uvicorn access logs
    # Must come BEFORE parser to filter early

[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        Off
    # Extract all JSON fields from the log message
    # Preserve_Key Off removes the original 'log' field after parsing
    # This ensures trace_id, service, level, etc. are extracted as top-level fields

[FILTER]
    Name                nest
    Match               docker.*
    Operation           lift
    Nested_under        context
    Add_prefix          ""
    # Lift nested fields from context.* to top level
    # This moves context.status_code -> status_code, context.path -> path, etc.
    # Note: This only lifts if context exists, so it won't break other logs
    # After lifting, status_code will be available as a top-level field

[FILTER]
    Name                modify
    Match               docker.*
    Condition           Key_exists status_code
    Rename              status_code statusCode
    # Rename lifted status_code to camelCase statusCode
    # This makes it easier to search in OpenSearch Dashboards

[FILTER]
    Name                modify
    Match               docker.*
    Add                 collector fluent-bit

[FILTER]
    Name                lua
    Match               docker.*
    Script              /fluent-bit/scripts/extract_context.lua
    Call                extract_context_fields
    # Extract and flatten context fields, req.* and res.* fields for easier searching

[FILTER]
    Name                lua
    Match               docker.*
    Script              /fluent-bit/scripts/extract_context.lua
    Call                add_jaeger_url
    # Add Jaeger trace URL field for clickable links in OpenSearch Dashboards

[FILTER]
    Name                lua
    Match               docker.*
    Script              /fluent-bit/scripts/extract_context.lua
    Call                filter_dashboard_logs
    # Log filtering based on service + endpoint whitelist:
    # Only logs matching BOTH service AND endpoint are kept. All other logs are dropped.
    # 
    # Allowed combinations (hardcoded in extract_context.lua):
    # - asr-service: /asr/inference, /api/v1/asr/inference
    # - audio-lang-detection-service: /audio-lang-detection/inference, /api/v1/audio-lang-detection/inference
    # - language-detection-service: /language-detection/inference, /api/v1/language-detection/inference
    # - language-diarization-service: /language-diarization/inference, /api/v1/language-diarization/inference
    # - llm-service: /llm/inference, /api/v1/llm/inference
    # - ner-service: /ner/inference, /api/v1/ner/inference
    # - nmt-service: /nmt/inference, /api/v1/nmt/inference
    # - ocr-service: /ocr/inference, /api/v1/ocr/inference
    # - pipeline-service: /pipeline/inference, /api/v1/pipeline/inference
    # - speaker-diarization-service: /speaker-diarization/inference, /api/v1/speaker-diarization/inference
    # - transliteration-service: /transliteration/inference, /api/v1/transliteration/inference
    # - tts-service: /tts/inference, /api/v1/tts/inference
    # - auth-service: /auth/login, /api/v1/auth/login, /auth/logout, /api/v1/auth/logout
    #
    # Environment variables:
    # - EXCLUDE_INIT_LOGS: Filter initialization/noise logs (startup messages)
    #   Set to "true" to exclude service initialization logs (e.g., "Service started successfully",
    #   "Registered service with service registry", "Plugin initialized", etc.)
    #   Example: EXCLUDE_INIT_LOGS=true
    # Returns -1 to drop logs, 1 to keep

[OUTPUT]
    Name  opensearch
    Match docker.*
    Host  opensearch
    Port  9200
    Index logs
    Logstash_Format On
    Logstash_Prefix logs
    Logstash_DateFormat %Y.%m.%d
    Retry_Limit 5
    Suppress_Type_Name On

