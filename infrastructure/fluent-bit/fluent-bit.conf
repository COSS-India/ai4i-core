[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    Trace_Error   On

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   Off
    Rotate_Wait       30

# --------------------------------------------------
# Parse application JSON logs (if present)
# This runs SAFELY even for non-JSON logs
# --------------------------------------------------

[FILTER]
    Name                grep
    Match               docker.*
    Regex               log ^\{

[FILTER]
    Name            parser
    Match           docker.*
    Key_Name        log
    Parser          json
    Reserve_Data    On
    Preserve_Key    On
    # If parsing fails, log field remains untouched

# --------------------------------------------------
# Lift context.* fields to top-level (optional)
# --------------------------------------------------
[FILTER]
    Name            nest
    Match           docker.*
    Operation       lift
    Nested_under    context

# --------------------------------------------------
# Rename status_code -> statusCode (if exists)
# --------------------------------------------------
[FILTER]
    Name            modify
    Match           docker.*
    Condition       Key_exists status_code
    Rename          status_code statusCode

# --------------------------------------------------
# Add metadata
# --------------------------------------------------
[FILTER]
    Name            modify
    Match           docker.*
    Add             collector fluent-bit
    Add             environment production

[OUTPUT]
    Name                    opensearch
    Match                   docker.*
    Host                    opensearch
    Port                    9200
    Index                   logs
    Retry_Limit             False
    Suppress_Type_Name      On
    tls                     Off
    tls.verify              Off
